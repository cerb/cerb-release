{
    "name": "cerb.mail.compose",
    "description": "Compose a new message",
    "extension_id": "cerb.trigger.interaction.worker",
    "script": "inputs:\r\n  text/record_type:\r\n    type: record_type\r\n    required@bool: yes\r\n  text/record_id:\r\n    type: number\r\n    required@bool: yes\r\n\r\nstart:\r\n  record.get/load:\r\n    output: record\r\n    inputs:\r\n      record_type@key: inputs:record_type\r\n      record_id@key: inputs:record_id\r\n  \r\n  # Create a draft based on the record type (address, contact, org)\r\n  decision/type:\r\n    outcome/address:\r\n      if@bool: {{inputs.record_type is record type ('address')}}\r\n      then:\r\n        record.create:\r\n          output: draft_record\r\n          inputs:\r\n            record_type: draft\r\n            # See: https://cerb.ai/docs/records/types/draft/\r\n            fields:\r\n              name: Draft for {{record.email}}\r\n              type: mail.compose\r\n              worker_id@key,int: worker_id\r\n              params:\r\n                to: {{record.email}}\r\n                org_name: {{record.org_name}}\r\n                content@text:\r\n                  {% if record.contact_first_name %}\r\n                  Hi {{record.contact_first_name}},\r\n                  \r\n                  {% endif %}\r\n                  \r\n                  #signature\r\n    outcome/contact:\r\n      if@bool: {{inputs.record_type is record type ('contact')}}\r\n      then:\r\n        record.create:\r\n          output: draft_record\r\n          inputs:\r\n            record_type: draft\r\n            # See: https://cerb.ai/docs/records/types/draft/\r\n            fields:\r\n              name: Draft for {{record.email__label}}\r\n              type: mail.compose\r\n              worker_id@key,int: worker_id\r\n              params:\r\n                to: {{record.email__label}}\r\n                org_name: {{record.org__label}}\r\n                content@text:\r\n                  {% if record.first_name %}\r\n                  Hi {{record.first_name}},\r\n                  \r\n                  {% endif %}\r\n                  \r\n                  #signature\r\n    outcome/org:\r\n      if@bool: {{inputs.record_type is record type ('org')}}\r\n      then:\r\n        record.create:\r\n          output: draft_record\r\n          inputs:\r\n            record_type: draft\r\n            # See: https://cerb.ai/docs/records/types/draft/\r\n            fields:\r\n              name: Draft for {{record.name}}\r\n              type: mail.compose\r\n              worker_id@key,int: worker_id\r\n              params:\r\n                to: {{record.email__label}}\r\n                org_name: {{record.name}}\r\n                content@text:\r\n                  Hi {{record.name}},\r\n                  \r\n                  #signature\r\n    outcome/else:\r\n      then:\r\n        record.create:\r\n          output: draft_record\r\n          inputs:\r\n            record_type: draft\r\n            # See: https://cerb.ai/docs/records/types/draft/\r\n            fields:\r\n              name: Draft by {{worker__label}}\r\n              type: mail.compose\r\n              worker_id@key,int: worker_id\r\n              params:\r\n                to@text:\r\n                content@text:\r\n                  \r\n                  \r\n                  #signature\r\n\r\n  await/draft:\r\n    draft:\r\n      uri: cerb:draft:{{draft_record.id}}\r\n      output: results_draft\r\n  \r\n  decision/draft_status:\r\n    outcome/sent:\r\n      if@bool: {{results_draft.status ends with '.sent'}}\r\n      then:\r\n        await:\r\n          form:\r\n            elements:\r\n              sheet/draft:\r\n                data:\r\n                  0:\r\n                    id: {{results_draft.record.id}}\r\n                    _context: {{results_draft.record._context}}\r\n                    _label: {{results_draft.record._label}}\r\n                schema:\r\n                  columns:\r\n                    card/_label:\r\n                      label: Message sent!\r\n    outcome/draft:\r\n      if@bool: {{results_draft.status ends with '.draft'}}\r\n      then:\r\n        await:\r\n          form:\r\n            elements:\r\n              sheet/draft:\r\n                data:\r\n                  0:\r\n                    id: {{results_draft.record.id}}\r\n                    _context: {{results_draft.record._context}}\r\n                    _label: {{results_draft.record._label}}\r\n                schema:\r\n                  columns:\r\n                    card/_label:\r\n                      label: Draft saved!\r\n    outcome/discard:\r\n      if@bool: {{results_draft.status ends with '.discard'}}",
    "policy_kata": "commands:\r\n  record.get:\r\n    deny@bool: {{inputs.record_type is not record type ('address', 'contact', 'org')}}\r\n    allow@bool: yes\r\n  record.create:\r\n    deny@bool: {{inputs.record_type is not record type ('draft')}}\r\n    allow@bool: yes",
    "created_at": 1615256479,
    "updated_at": 1615862702
}
{
    "name": "cerb.reply.recentActivity",
    "description": "Check for recent activity before starting a reply",
    "extension_id": "cerb.trigger.mail.reply.validate",
    "script": "inputs:\r\n  record/message:\r\n    record_type: message\r\n    required@bool: yes\r\n    default: {{caller_params.message_id}}\r\n\r\nstart:\r\n  # Load active drafts on this ticket by other workers\r\n  record.search/drafts:\r\n    inputs:\r\n      record_type: draft\r\n      record_query@text:\r\n        ticket.id:${ticket_id} \r\n        worker.id:!${worker_id} \r\n        is.queued:no \r\n        updated:\"-15 mins to now\"\r\n      record_query_params:\r\n        ticket_id: {{inputs.message.ticket_id}}\r\n        worker_id: {{worker_id}}\r\n    output: drafts\r\n    on_success:\r\n      # If there are drafts\r\n      outcome/notEmpty:\r\n        if@bool: {{drafts is not empty and drafts is iterable}}\r\n        then:\r\n          await:\r\n            form:\r\n              title: Duplication of effort?\r\n              elements:\r\n                sheet/others:\r\n                  data@key: drafts\r\n                  label: Other workers are currently responding to this ticket:\r\n                  schema:\r\n                    columns:\r\n                      date/updated:\r\n                        label: When\r\n                      card/worker_id:\r\n                        label: Who\r\n                      card/id:\r\n                        label: Draft\r\n                submit/prompt_continue:\r\n                  buttons:\r\n                    continue/yes:\r\n                      label: Reply anyway\r\n                      icon: circle-ok\r\n                      icon_at: start\r\n                      value: yes\r\n                    continue/no:\r\n                      label: Abort\r\n                      style: secondary\r\n                      value: no\r\n          outcome/abort:\r\n            if@bool: {{'yes' != prompt_continue}}\r\n            then:\r\n              return:\r\n                reject@bool: true\r\n  \r\n  # Load recent activity log entries this ticket\r\n  record.search/logs:\r\n    inputs:\r\n      record_type: activity_log\r\n      record_query@text:\r\n        target.ticket:(id:${ticket_id})\r\n        created:\"-15 minutes\"\r\n        activity:[ticket.status.closed,ticket.status.waiting,ticket.status.deleted,ticket.message.outbound]\r\n        actor:worker\r\n        actor.worker:!(id:${worker_id})\r\n      record_query_params:\r\n        ticket_id: {{inputs.message.ticket_id}}\r\n        worker_id: {{worker_id}}\r\n    output: logs\r\n    on_success:\r\n      outcome/notEmpty:\r\n        if@bool: {{logs is not empty and logs is iterable}}\r\n        then:\r\n          await:\r\n            form:\r\n              title: Recent activity\r\n              elements:\r\n                sheet/recent:\r\n                  label: There is recent activity on this ticket:\r\n                  data@key: logs\r\n                  schema:\r\n                    layout:\r\n                      headings@bool: no\r\n                      filtering@bool: no\r\n                    columns:\r\n                      date/created:\r\n                      text/_label:\r\n                submit/prompt_continue:\r\n                  buttons:\r\n                    continue/yes:\r\n                      label: Reply anyway\r\n                      icon: circle-ok\r\n                      icon_at: start\r\n                      value: yes\r\n                    continue/no:\r\n                      label: Abort\r\n                      style: secondary\r\n                      value: no\r\n          outcome/abort:\r\n            if@bool: {{'yes' != prompt_continue}}\r\n            then:\r\n              return:\r\n                reject@bool: true\r\n",
    "policy_kata": "commands:\r\n  record.search:\r\n    deny/type@bool: {{inputs.record_type is not record type ('draft','activity_log')}}\r\n    allow@bool: yes",
    "created_at": 1638575040,
    "updated_at": 1649717100
}
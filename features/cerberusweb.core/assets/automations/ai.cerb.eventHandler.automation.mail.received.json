{
    "name": "ai.cerb.eventHandler.automation.mail.received",
    "description": "",
    "extension_id": "cerb.trigger.interaction.internal",
    "script": "start:\r\n  await/type:\r\n    form:\r\n      title: Generate an automation\r\n      elements:\r\n        sheet/prompt_type:\r\n          data:\r\n            0:\r\n              key: autoreply\r\n              label: Auto-reply\r\n              description: Send an auto-reply to new messages\r\n          schema:\r\n            layout:\r\n              filtering@bool: no\r\n              headings@bool: no\r\n              paging@bool: no\r\n              title_column: label\r\n            columns:\r\n              selection/key:\r\n                params:\r\n                  mode: single\r\n              text/label:\r\n              text/description:\r\n      \r\n  await/prompt:\r\n    form:\r\n      title: Prompts\r\n      elements:\r\n        text/prompt_name:\r\n          label: Name:\r\n          type: text\r\n          required@bool: yes\r\n          default: {{random_string(6)|lower}}.mail.received.autoReply\r\n          validation@text:\r\n            {% if prompt_name|alphanum('.-_') != prompt_name %}\r\n            The name can only contain letters, numbers, dots, and dashes.\r\n            {% endif %}\r\n  \r\n  # [TODO] Don't email automated senders\r\n  record.create/automation:\r\n    output: new_automation\r\n    inputs:\r\n      record_type: automation\r\n      fields:\r\n        name@key: prompt_name\r\n        description: Send an auto-reply for new inbound mail\r\n        extension_id: cerb.trigger.mail.received\r\n        script@raw:\r\n          start:\r\n            # Don't send auto-replies to automated senders\r\n            outcome/isAutoSender:\r\n              if@bool:\r\n                {{\r\n                  message_sender_email is prefixed ('postmaster@','mailer-daemon@')\r\n                  or message_headers['auto-submitted'] is prefixed ('auto-')\r\n                  or message_headers['precedence'] == 'bulk'\r\n                  or message_headers['preference'] == 'auto_reply'\r\n                  or message_headers['x-precedence']\r\n                  or message_headers['x-autorespond']\r\n                  or message_headers['x-autogenerated']\r\n                  or message_headers['x-autoreply-from']\r\n                  or 'autoreply' in message_headers['x-auto-response-suppress']|lower\r\n                  or 'out of office' in message_headers['subject']|lower\r\n                  or 'out of the office' in message_headers['subject']|lower\r\n                }}    \r\n              then:\r\n                return:\r\n            \r\n            # See: https://cerb.ai/docs/automations/commands/record.create/\r\n            record.create/draft:\r\n              output: new_draft\r\n              inputs:\r\n                record_type: draft\r\n                # See: https://cerb.ai/docs/records/types/draft/#records-api\r\n                fields:\r\n                  type: mail.transactional\r\n                  name: Auto-reply to {{message_sender_email}}\r\n                  to: {{message_sender_email}}\r\n                  is_queued: 1\r\n                  queue_delivery_date@date: now\r\n                  params:\r\n                    to: {{message_sender_email}}\r\n                    from: support@cerb.example\r\n                    subject: Auto-Reply: {{message_ticket_subject}}\r\n                    headers:\r\n                      Auto-Submitted: auto-replied\r\n                      Precedence: bulk\r\n                    content@text:\r\n                      Thanks for writing!\r\n                      \r\n                      Your reference number is #{{message_ticket_mask}}.\r\n        policy_kata@raw:\r\n          commands:\r\n            record.create:\r\n              deny/type@bool: {{inputs.record_type is not record type ('draft')}}\r\n              allow@bool: yes        \r\n  set:\r\n    snippet:\r\n      automation/autoReply:\r\n        uri: cerb:automation:{{prompt_name}}\r\n        disabled@raw,bool: {{not is_new_ticket}}\r\n  \r\n  return:\r\n    snippet: {{snippet|kata_encode}}",
    "policy_kata": "commands:\r\n  record.create:\r\n    deny/type@bool: {{inputs.record_type is not record type ('automation')}}\r\n    allow@bool: yes",
    "created_at": 1624584588,
    "updated_at": 1624666154
}
{
    "name": "ai.cerb.eventHandler.automation.mail.received",
    "description": "",
    "extension_id": "cerb.trigger.interaction.internal",
    "script": "start:\n  await/type:\n    form:\n      title: Generate an automation\n      elements:\n        sheet/prompt_type:\n          data:\n            0:\n              key: autoreply\n              label: Auto-reply\n              description: Send an auto-reply to new messages\n          schema:\n            layout:\n              filtering@bool: no\n              headings@bool: no\n              paging@bool: no\n              title_column: label\n            columns:\n              selection/key:\n                params:\n                  mode: single\n              text/label:\n              text/description:\n      \n  await/prompt:\n    form:\n      title: Prompts\n      elements:\n        text/prompt_name:\n          label: Name:\n          type: text\n          required@bool: yes\n          default: {{random_string(6)|lower}}.mail.received.autoReply\n          validation@text:\n            {% if prompt_name|alphanum('.-_') != prompt_name %}\n            The name can only contain letters, numbers, dots, and dashes.\n            {% endif %}\n  \n  record.create/automation:\n    output: new_automation\n    inputs:\n      record_type: automation\n      fields:\n        name@key: prompt_name\n        description: Send an auto-reply for new inbound mail\n        extension_id: cerb.trigger.mail.received\n        script@raw:\n          start:\n            # Don't send auto-replies to automated senders\n            outcome/isAutoSender:\n              if@bool:\n                {{\n                  message_sender_email is prefixed ('postmaster@','mailer-daemon@')\n                  or message_headers['auto-submitted'] is prefixed ('auto-')\n                  or message_headers['precedence'] == 'bulk'\n                  or message_headers['preference'] == 'auto_reply'\n                  or message_headers['x-precedence']\n                  or message_headers['x-autorespond']\n                  or message_headers['x-autogenerated']\n                  or message_headers['x-autoreply-from']\n                  or 'all' == message_headers['x-auto-response-suppress']|lower\n                  or 'autoreply' in message_headers['x-auto-response-suppress']|lower\n                  or 'out of office' in message_headers['subject']|lower\n                  or 'out of the office' in message_headers['subject']|lower\n                }}    \n              then:\n                return:\n            \n            # See: https://cerb.ai/docs/automations/commands/record.create/\n            record.create/draft:\n              output: new_draft\n              inputs:\n                record_type: draft\n                # See: https://cerb.ai/docs/records/types/draft/#records-api\n                fields:\n                  type: mail.transactional\n                  name: Auto-reply to {{message_sender_email}}\n                  to: {{message_sender_email}}\n                  is_queued: 1\n                  queue_delivery_date@date: now\n                  params:\n                    to: {{message_sender_email}}\n                    from: support@cerb.example\n                    subject: Auto-Reply: {{message_ticket_subject}}\n                    headers:\n                      Auto-Submitted: auto-replied\n                      Precedence: bulk\n                    content@text:\n                      Thanks for writing!\n                      \n                      Your reference number is #{{message_ticket_mask}}.\n        policy_kata@raw:\n          commands:\n            record.create:\n              deny/type@bool: {{inputs.record_type is not record type ('draft')}}\n              allow@bool: yes        \n  set:\n    snippet:\n      automation/autoReply:\n        uri: cerb:automation:{{prompt_name}}\n        disabled@raw,bool: {{not is_new_ticket}}\n  \n  return:\n    snippet: {{snippet|kata_encode}}",
    "policy_kata": "commands:\r\n  record.create:\r\n    deny/type@bool: {{inputs.record_type is not record type ('automation')}}\r\n    allow@bool: yes",
    "created_at": 1624584588,
    "updated_at": 1624666154
}